# Makefile.config - Configuration Protocol for Infra Makefile Framework
#
# This file provides:
# 1. Config file loading (Makefile.local for overrides)
# 2. Target filtering mechanism
# 3. Default values for all configuration variables
#
# Precedence (highest to lowest):
# 1. Environment variables
# 2. Makefile variables set before include
# 3. Makefile.local (optional overrides)
# 4. Defaults defined here
#
# For selective module inclusion, include individual Makefiles instead
# of using Makefile.all. See Makefile.all header for examples.
#
# Usage:
#   include path/to/Makefile.config
#   # or use Makefile.all which includes this automatically

# ============================================================================
# Configuration File Loading
# ============================================================================

# Search for optional config file (Makefile.local for overrides)
_infra_config_file := $(strip \
    $(if $(wildcard $(CURDIR)/Makefile.local),$(CURDIR)/Makefile.local,))

# Include config file if found (uses ?= so env/Makefile vars take precedence)
ifneq ($(_infra_config_file),)
-include $(_infra_config_file)
endif

# ============================================================================
# Target Filtering
# ============================================================================

# Space-separated list of targets to disable (e.g., "release pg.clean")
INFRA_DISABLE_TARGETS ?=

# Space-separated list of target prefixes to disable (e.g., "pg. cicd.")
INFRA_DISABLE_GROUPS ?=

# Helper macro to check if a target is disabled
# Usage: $(call _infra_check_target,target_name)
# Returns: shell command to exit 0 if disabled, empty otherwise
define _infra_check_target
$(if $(filter $1,$(INFRA_DISABLE_TARGETS)),@echo "Target '$1' is disabled via INFRA_DISABLE_TARGETS" && exit 0,$(if $(strip $(foreach g,$(INFRA_DISABLE_GROUPS),$(if $(filter $(g)%,$1),yes,))),@echo "Target '$1' is disabled via INFRA_DISABLE_GROUPS" && exit 0,))
endef

# ============================================================================
# Dry Run Mode
# ============================================================================

# Set INFRA_DRY_RUN=1 to show commands without executing
INFRA_DRY_RUN ?= 0

# Export for subprocesses (check.sh uses this)
export INFRA_DRY_RUN

# Helper macro for dry-run aware command execution
# Usage: $(call _run_or_show,command_description,actual_command)
define _run_or_show
@if [ "$(INFRA_DRY_RUN)" = "1" ]; then \
	echo "[DRY RUN] Would run: $(1)"; \
else \
	$(2); \
fi
endef

# ============================================================================
# Validation Helpers
# ============================================================================

# Validate INFRA_DEV_PKG_NAME points to a valid Python package
# Usage: $(call _validate_pkg_name,package_name)
# Call at the start of targets that require a valid package
define _validate_pkg_name
$(if $(wildcard $(1)/__init__.py),,$(error \
Package '$(1)' is not a valid Python package. \
Check INFRA_DEV_PKG_NAME in your Makefile. Run 'make doctor' for diagnostics.))
endef

# Check if a tool is available
# Usage: $(call _check_tool,tool_name,install_hint)
define _check_tool
@command -v $(1) >/dev/null 2>&1 || { \
	echo ""; \
	echo "ERROR: $(1) not found"; \
	echo ""; \
	echo "To fix: $(2)"; \
	echo ""; \
	exit 1; \
}
endef

# ============================================================================
# Default Values for Configuration Variables
# ============================================================================

# ENV module
INFRA_ENV_PYTHON ?=
# Note: Actual default handled in Makefile.env (detection logic)

# DEV module
INFRA_DEV_PKG_NAME ?= appinfra
INFRA_DEV_CQ_STRICT ?= false
INFRA_DEV_PROJECT_ROOT ?= $(CURDIR)
# INFRA_DEV_CHECK_SCRIPT - derived in Makefile.dev

# PYTEST module
INFRA_PYTEST_COVERAGE_PKG ?= $(INFRA_DEV_PKG_NAME)
INFRA_PYTEST_COVERAGE_MARKERS ?= unit
INFRA_PYTEST_COVERAGE_THRESHOLD ?= 95.0
INFRA_PYTEST_TESTS_DIR ?= tests
INFRA_PYTEST_ARGS ?=

# Config module - ETC_DIR and default config file
ETC_DIR ?= $(CURDIR)/etc
INFRA_DEFAULT_CONFIG_FILE ?= infra.yaml

# DOCS module (empty = use INFRA_DEFAULT_CONFIG_FILE)
INFRA_DOCS_CONFIG_FILE ?=
INFRA_DOCS_OUTPUT_DIR ?= .site

# PG module (empty = use INFRA_DEFAULT_CONFIG_FILE)
INFRA_PG_CONFIG_FILE ?=
INFRA_PG_CONFIG_KEY ?= pgserver
INFRA_PG_DATABASES ?=
INFRA_PG_HOST ?= 127.0.0.1
INFRA_PG_USER ?= postgres

# CICD module
INFRA_CICD_PYTHON_VERSION ?= 3.12

# CLEAN module
INFRA_CLEAN_PRESERVE ?= .data .logs .GRADING.md

# ============================================================================
# Config Target
# ============================================================================

##@ Configuration

config: ## Show current infra framework configuration
	@echo "Infra Framework Configuration"
	@echo "=============================="
	@echo ""
	@echo "Config file: $(if $(_infra_config_file),$(_infra_config_file),(none found))"
	@echo ""
	@echo "Target Filtering:"
	@echo "  INFRA_DISABLE_TARGETS: $(if $(INFRA_DISABLE_TARGETS),$(INFRA_DISABLE_TARGETS),(none))"
	@echo "  INFRA_DISABLE_GROUPS:  $(if $(INFRA_DISABLE_GROUPS),$(INFRA_DISABLE_GROUPS),(none))"
	@echo ""
	@echo "Development (DEV):"
	@echo "  INFRA_DEV_PKG_NAME:     $(INFRA_DEV_PKG_NAME)"
	@echo "  INFRA_DEV_CQ_STRICT:    $(INFRA_DEV_CQ_STRICT)"
	@echo "  INFRA_DEV_PROJECT_ROOT: $(INFRA_DEV_PROJECT_ROOT)"
	@echo ""
	@echo "Testing (PYTEST):"
	@echo "  INFRA_PYTEST_COVERAGE_PKG:       $(INFRA_PYTEST_COVERAGE_PKG)"
	@echo "  INFRA_PYTEST_COVERAGE_THRESHOLD: $(INFRA_PYTEST_COVERAGE_THRESHOLD)"
	@echo "  INFRA_PYTEST_TESTS_DIR:          $(INFRA_PYTEST_TESTS_DIR)"
	@echo "  INFRA_PYTEST_ARGS:               $(if $(INFRA_PYTEST_ARGS),$(INFRA_PYTEST_ARGS),(none))"
	@echo ""
	@echo "Config:"
	@echo "  ETC_DIR:                   $(ETC_DIR)"
	@echo "  INFRA_DEFAULT_CONFIG_FILE: $(INFRA_DEFAULT_CONFIG_FILE)"
	@echo ""
	@echo "Documentation (DOCS):"
	@echo "  INFRA_DOCS_CONFIG_FILE: $(if $(INFRA_DOCS_CONFIG_FILE),$(INFRA_DOCS_CONFIG_FILE),(using default))"
	@echo "  INFRA_DOCS_OUTPUT_DIR:  $(INFRA_DOCS_OUTPUT_DIR)"
	@echo ""
	@echo "PostgreSQL (PG):"
	@echo "  INFRA_PG_CONFIG_FILE: $(if $(INFRA_PG_CONFIG_FILE),$(INFRA_PG_CONFIG_FILE),(using default))"
	@echo "  INFRA_PG_CONFIG_KEY:  $(INFRA_PG_CONFIG_KEY)"
	@echo "  INFRA_PG_HOST:       $(INFRA_PG_HOST)"
	@echo "  INFRA_PG_USER:       $(INFRA_PG_USER)"
	@echo "  INFRA_PG_DATABASES:  $(if $(INFRA_PG_DATABASES),$(INFRA_PG_DATABASES),(none))"
	@echo ""
	@echo "CI/CD (CICD):"
	@echo "  INFRA_CICD_PYTHON_VERSION: $(INFRA_CICD_PYTHON_VERSION)"
	@echo ""
	@echo "Cleanup (CLEAN):"
	@echo "  INFRA_CLEAN_PRESERVE: $(INFRA_CLEAN_PRESERVE)"
.PHONY: config
