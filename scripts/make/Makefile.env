# Makefile.env - Python Environment Detection
#
# Determines which Python interpreter to use. Priority:
# 1. INFRA_ENV_PYTHON environment variable (highest priority)
# 2. PYTHON environment variable (legacy, for backward compatibility)
# 3. Makefile.local file (project-local override, gitignored)
# 4. ~/.venv/bin/python (default virtualenv location)
# 5. Error with helpful message
#
# Configuration variables (set in Makefile before include):
#   INFRA_ENV_PYTHON - Path to Python interpreter
#
# Usage in other Makefiles:
#   include path/to/Makefile.env
#
# To override, either:
#   export INFRA_ENV_PYTHON=/path/to/your/python
#   # or (legacy)
#   export PYTHON=/path/to/your/python
#   # or
#   echo 'INFRA_ENV_PYTHON ?= /path/to/your/python' > Makefile.local
#
# Note: Use ?= in Makefile.local so env vars can still override when needed.

# Track source before any overrides
ifdef INFRA_ENV_PYTHON
  _PYTHON_SOURCE := INFRA_ENV_PYTHON environment variable
  PYTHON := $(INFRA_ENV_PYTHON)
else ifdef PYTHON
  _PYTHON_SOURCE := PYTHON environment variable (legacy)
endif

# Note: Makefile.local is included by Makefile.config (loaded before this file)

# Track if Makefile.local set PYTHON or INFRA_ENV_PYTHON
ifndef _PYTHON_SOURCE
  ifdef INFRA_ENV_PYTHON
    _PYTHON_SOURCE := Makefile.local (INFRA_ENV_PYTHON)
    PYTHON := $(INFRA_ENV_PYTHON)
  else ifdef PYTHON
    _PYTHON_SOURCE := Makefile.local (PYTHON)
  endif
endif

# If PYTHON not already set, detect it
ifndef PYTHON
  ifneq ($(wildcard $(HOME)/.venv/bin/python),)
    PYTHON := $(HOME)/.venv/bin/python
    _PYTHON_SOURCE := ~/.venv (default)
  else
    $(error No Python environment found. Options: 1) Create ~/.venv virtualenv, 2) Set INFRA_ENV_PYTHON env var, 3) Create Makefile.local with INFRA_ENV_PYTHON=path)
  endif
endif

# Set INFRA_ENV_PYTHON from PYTHON for consistency
INFRA_ENV_PYTHON := $(PYTHON)

##@ Environment

env: ## Show current environment configuration
	@echo "Environment Configuration"
	@echo "========================="
	@echo ""
	@echo "Python:"
	@echo "  Path:    $(PYTHON)"
	@echo "  Version: $$($(PYTHON) --version 2>&1)"
	@echo "  Source:  $(_PYTHON_SOURCE)"
	@echo ""
	@echo "Makefile.local: $$(if [ -f Makefile.local ]; then echo "exists"; else echo "not present"; fi)"
	@if [ -f Makefile.local ]; then echo "  Contents:"; cat Makefile.local | sed 's/^/    /'; fi
	@echo ""
	@echo "Project Root: $(CURDIR)"
	@echo ""
	@echo "Development (INFRA_DEV_*):"
	@echo "  PKG_NAME:       $(INFRA_DEV_PKG_NAME)"
	@echo "  CQ_STRICT:      $(INFRA_DEV_CQ_STRICT)"
	@echo "  PROJECT_ROOT:   $(INFRA_DEV_PROJECT_ROOT)"
	@echo "  INSTALL_EXTRAS: $(INFRA_DEV_INSTALL_EXTRAS)"
	@echo "  CHECK_SCRIPT:   $(INFRA_DEV_CHECK_SCRIPT)"
	@echo ""
	@echo "Testing (INFRA_PYTEST_*):"
	@echo "  TESTS_DIR:      $(INFRA_PYTEST_TESTS_DIR)"
	@echo "  COVERAGE_PKG:   $(INFRA_PYTEST_COVERAGE_PKG)"
	@echo "  ARGS:           $(INFRA_PYTEST_ARGS)"
	@echo ""
	@echo "Docs (INFRA_DOCS_*):"
	@echo "  CONFIG:         $(INFRA_DOCS_CONFIG)"
	@echo "  OUTPUT_DIR:     $(INFRA_DOCS_OUTPUT_DIR)"
	@echo ""
	@echo "PostgreSQL (INFRA_PG_*):"
	@echo "  CONFIG:         $(INFRA_PG_CONFIG)"
	@echo "  CONFIG_KEY:     $(INFRA_PG_CONFIG_KEY)"
	@echo "  DATABASES:      $(INFRA_PG_DATABASES)"
	@echo "  HOST:           $(INFRA_PG_HOST)"
	@echo "  USER:           $(INFRA_PG_USER)"
	@echo ""
	@echo "CI/CD (INFRA_CICD_*):"
	@echo "  PYTHON_VERSION: $(INFRA_CICD_PYTHON_VERSION)"
	@echo ""
	@echo "Other:"
	@echo "  INFRA_DRY_RUN:        $(INFRA_DRY_RUN)"
	@echo "  INFRA_CLEAN_PRESERVE: $(INFRA_CLEAN_PRESERVE)"
	@echo "  INFRA_DISABLE_TARGETS: $(INFRA_DISABLE_TARGETS)"
	@echo "  INFRA_DISABLE_GROUPS:  $(INFRA_DISABLE_GROUPS)"
	@echo ""
	@echo "Environment Variables:"
	@echo "  INFRA_TEST_LOGGING_LEVEL: $${INFRA_TEST_LOGGING_LEVEL:-<not set>}"
	@echo "  INFRA_LOGGING_LEVEL:      $${INFRA_LOGGING_LEVEL:-<not set>}"
.PHONY: env
