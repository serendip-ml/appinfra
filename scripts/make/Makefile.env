# Makefile.env - Python Environment Detection
#
# Determines which Python interpreter to use. Priority:
# 1. INFRA_ENV_PYTHON environment variable (highest priority)
# 2. PYTHON environment variable (legacy, for backward compatibility)
# 3. Makefile.local file (project-local override, gitignored)
# 4. ~/.venv/bin/python (default virtualenv location)
# 5. Error with helpful message
#
# Configuration variables (set in Makefile before include):
#   INFRA_ENV_PYTHON - Path to Python interpreter
#
# Usage in other Makefiles:
#   include path/to/Makefile.env
#
# To override, either:
#   export INFRA_ENV_PYTHON=/path/to/your/python
#   # or (legacy)
#   export PYTHON=/path/to/your/python
#   # or
#   echo 'INFRA_ENV_PYTHON ?= /path/to/your/python' > Makefile.local
#
# Note: Use ?= in Makefile.local so env vars can still override when needed.

# Track source before any overrides
ifdef INFRA_ENV_PYTHON
  _PYTHON_SOURCE := INFRA_ENV_PYTHON environment variable
  PYTHON := $(INFRA_ENV_PYTHON)
else ifdef PYTHON
  _PYTHON_SOURCE := PYTHON environment variable (legacy)
endif

# Include project-local overrides if present (gitignored)
-include Makefile.local

# Track if Makefile.local set PYTHON or INFRA_ENV_PYTHON
ifndef _PYTHON_SOURCE
  ifdef INFRA_ENV_PYTHON
    _PYTHON_SOURCE := Makefile.local (INFRA_ENV_PYTHON)
    PYTHON := $(INFRA_ENV_PYTHON)
  else ifdef PYTHON
    _PYTHON_SOURCE := Makefile.local (PYTHON)
  endif
endif

# If PYTHON not already set, detect it
ifndef PYTHON
  ifneq ($(wildcard $(HOME)/.venv/bin/python),)
    PYTHON := $(HOME)/.venv/bin/python
    _PYTHON_SOURCE := ~/.venv (default)
  else
    $(error No Python environment found. Options: 1) Create ~/.venv virtualenv, 2) Set INFRA_ENV_PYTHON env var, 3) Create Makefile.local with INFRA_ENV_PYTHON=path)
  endif
endif

# Set INFRA_ENV_PYTHON from PYTHON for consistency
INFRA_ENV_PYTHON := $(PYTHON)

##@ Environment

env: ## Show current environment configuration
	@echo "Environment Configuration"
	@echo "========================="
	@echo ""
	@echo "Python:"
	@echo "  Path:    $(PYTHON)"
	@echo "  Version: $$($(PYTHON) --version 2>&1)"
	@echo "  Source:  $(_PYTHON_SOURCE)"
	@echo ""
	@echo "Makefile.local: $$(if [ -f Makefile.local ]; then echo "exists"; else echo "not present"; fi)"
	@if [ -f Makefile.local ]; then echo "  Contents:"; cat Makefile.local | sed 's/^/    /'; fi
	@echo ""
	@echo "Key Environment Variables:"
	@echo "  INFRA_TEST_LOGGING_LEVEL: $${INFRA_TEST_LOGGING_LEVEL:-<not set>}"
	@echo "  INFRA_LOGGING_LEVEL:      $${INFRA_LOGGING_LEVEL:-<not set>}"
	@echo ""
	@echo "Project Root: $(CURDIR)"
.PHONY: env
